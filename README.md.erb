# swig-101

Introduction to [SWIG](http://www.swig.org/).

# HOWTO

## OSX

* Install macports
* sudo port install swig swig-ruby swig-python swig-java python3.8
* Install rbenv + ruby-build plugin
* rbenv install 2.7.1
* Install JVM 11.0.2
* Install clojure + clojure-tools

## Build

```
$ rbenv shell 2.7.1
$ bin/build clean all
```

<%
exit! if ENV['README_MD']
ENV['README_MD'] = '1'

require 'pp'

$verbose = false
$pe  = $verbose # || true
$msg = $verbose # || true

def msg *args
  if $msg
    $stderr.puts "\n  !!! #{$$} : README.md.erb : #{args * ' '}"
  end
end

def pe x
  if $verbose or $pe
    PP.pp(x, $stderr)
    $stderr.flush
  end
  x
end

def cmd cmd
  msg "cmd : #{cmd.inspect}"
  system "#{cmd} >tmp/cmd.out 2>&1"
  File.read("tmp/cmd.out")
end

def wrap_line line, width = 78
  words = line.strip.split(/\s+/)
  out = String.new
  line = String.new
  words.each do | word |
    if line.size + word.size > width
      out += line + " \\\n  "
      line = word
    else
      line += word + ' '
    end
    # pe(word: word, words: words)
  end
  out << line
end

make = `which gmake make 2>/dev/null`.split("\n").first
make = 'bin/build'

msg "Start"

examples = [ ]
targets = nil

cmd "#{make} all >/dev/null"
%>

<%
msg "Examples"

%w(example1.c example2.cc).each do | example_name |
  example_src     = "src/#{example_name}"
  example         = example_name.sub(/\.([^.]+)$/, '')
  example_suffix  = $1
  lang = example_suffix.upcase
  examples << (e = {
    name:     example_name,
    basename: example,
    src:      example_src,
    suffix:   example_suffix,
    lang:     lang,
  })

  msg "{{{ Example : #{e[:name]}"
  pe(e: e)

  targets = <<"END".split("\n").map{|l| l.split("|").map(&:strip).reject(&:empty?)}
#{lang} Header  | src/#{example}.h        | -
#{lang} Library | src/#{example_name}     | -
#{lang} Main    | src/#{example}-native.#{example_suffix} | target/native/#{example}
Ruby      | src/#{example}-ruby     | 
Python    | src/#{example}-python   |
TCL       | src/#{example}-tcl      |
Guile     | src/#{example}-guile    |
Clojure   | src/#{example}-clojure  | bin/run-clj src/#{example}-clojure
END

  targets =
    targets.
    map do |l|
      t = [:type, :file, :cmd].zip(l).to_h
      t[:name] ||= t[:file]
      if t[:cmd] == '-'
        t[:cmd] = nil
      else 
        t[:cmd] ||= t[:file]
      end
      t
    end

  pe(targets: targets)
%>

# <%= example.capitalize %>

<% targets.each do | t |
  msg "{{{ Example : #{e[:name]} : Program : #{t[:name]}"
%>
## <%= t[:type] %> -- <%= t[:file] %>

``` <%= t[:type].split(" ").first %>
<%= File.read(t[:file]).sub(/\A\n+|\n+\Z/, "\n") %>
```

<% if t[:cmd] %>
----

```
$ <%= t[:cmd] %>
<%= cmd t[:cmd] %>
```
<% end %>
<%
  msg "}}} Example : #{e[:name]} : Program : #{t[:name]}"
end
%>

## Output
<%
msg "{{{ Output"
targets.select{|t| t[:cmd]}.each do | t |
  msg "#{e[:name]} : #{t[:name]} : Output : {{{"
%>

```
$ <%= t[:cmd] %>
<%= cmd t[:cmd] %>
```

<%
  msg "}}} Example : #{e[:name]} : Output : #{t[:name]}"
end
%>
<%
  msg "}}} Example : #{e[:name]}"
end
msg "}}} Output"
%>

# Workflow

<% msg "{{{ Workflow" %>

* Compile native library
* Generate SWIG wrappers for target language
* Compile and link SWIG wrappers for target language with native library
* Load SWIG wrappers into target language

<%
[ examples.first ].each do | e |
%>
<%=
  msg "{{{ Workflow : #{e[:name]}"
  pe(e: e)
  
  # cmd "#{make} clean-example EXAMPLE=#{e[:name]}"
  cmd "#{make} clean"
  out = cmd "#{make} build-example EXAMPLE=#{e[:name]}"
  # pe(s: out)
  out = out.
  gsub('/opt/local/bin/gmake', 'make').
  gsub(' -I/opt/local/include ', ' ')
  lines = out.split("\n", 999999)
  # pe(lines: lines)
  lines.map{|l| wrap_line(l)}.join("\n")
%>
<%
  msg "}}} Workflow : #{e[:name]}"
end
%>
<%
msg "}}} Workflow"
cmd "#{make} all >/dev/null"
msg 'DONE'
%>
