#!/usr/bin/env bash

PATH="/opt/local/libexec/gnubin:$PATH" # macports

cmd=("$@")
dir="$(/bin/pwd)"

prog-path() { # VAR prog
  local var="$1"
  prog_name="$2" prog_exe= prog_dir= prog_home= prog_inc= prog_lib=
  shift 2
  "$@"
  : "${prog_exe:=$(which "$prog_name" || echo "$prog_name")}"
  : "${prog_dir:=$(dirname "$prog_exe")}"
  : "${prog_home:=$(cd "$prog_dir/.." && /bin/pwd)}"
  : "${prog_inc:=$prog_home/include}"
  : "${prog_lib:=$prog_home/lib}"
  # set -x
  export \
    "${var}_HOME=$prog_home" "${var}_EXE=$prog_exe" \
    "${var}_INC=$prog_inc" "${var}_LIB=$prog_lib"
  export PATH="$prog_dir:$PATH"
  # export LD_LIBRARY_PATH="$dir/target/$prog_name:$LD_LIBRARY_PATH"
  # export LD_RUN_PATH="$dir/target/$prog_name:$LD_RUN_PATH"
}

for swig_exe in "$SWIG_EXE" "$dir/../swig/swig" "$HOME/local/bin/swig" "$(which swig)" CANNOT-FIND-SWIG
do
  [[ -x "$swig_exe" ]] && break
done
export SWIG_EXE="${swig_exe:?}"
PATH="$(dirname "${swig_exe}"):$PATH"
PATH="$dir/bin:$PATH"

# (set -x; which swig); # exit

# set -x
prog-path PYTHON  python3.10
prog-path RUBY    ruby        declare prog_exe="$(rbenv which ruby)"
prog-path TCL     tclsh
prog-path GUILE   guile
prog-path JAVA    java

export RUBYOPT="-I$dir/target/ruby $RUBYOPT"
export GUILE_AUTO_COMPILE=0
export CLASSPATH="$dir/target/clojure:$CLASSPATH"
export PYTHONPATH="$dir/target/python:$PYTHONPATH"

case "${cmd[0]}"
in
  *.clj)
    target_dir="$dir/target/clojure"
    javac $target_dir/*.java 2>/dev/null
    export LD_LIBRARY_PATH="$target_dir:$LD_LIBRARY_PATH"
    export LD_RUN_PATH="$target_dir:$LD_RUN_PATH"
    CLASSPATH="$target_dir:$(clojure -Spath 2>/dev/null):$CLASSPATH"
    cmd=(clojure -Scp "${CLASSPATH}" -J-Djava.library.path="$target_dir" "${cmd[@]}")
  ;;
esac

exec "${cmd[@]}"
